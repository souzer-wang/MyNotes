### 18.Mysql数据库表类型有哪些？

MyISAM、InnoDB、HEAP、BOB,ARCHIVE,CSV等。

### MyISAM与InnoDB 的对比

#### MyISAM：
- 优点：
	- 成熟、稳定、易于管理
	- 强调性能，每次查询具有原子性，能快速读取

- 缺点：
	- 一些功能不支持（事务等）
	- 只有表级锁，不支持行锁

#### InnoDB：
- 优点：
	- 支持事务、外键等特性
- 缺点：
	- 空间占用大
	- 不支持全文索引



目前MySQL默认的存储引擎是InnoDB。

现在大多数时候我们使用的都是InnoDB，但是在某些情况下使用MyISAM更好，比如：MyISAM更适合读密集的表，而InnoDB更适合写密集的的表。在数据库做主从分离的情况下，经常选择MyISAM作为主库的存储引擎。


### 19.简述mysql的MVCC机制

MVCC是一种多版本并发控制机制，是MySQL的InnoDB存储引擎实现隔离级别的一种具体方式，用于实现提交读和可重复读这两种隔离级别。

MVCC实现原理。通过保存数据在某个时间点的快照来实现该机制，其在每行记录后面保存两个隐藏的列，分别保存这个行的创建版本号和删除版本号，然后Innodb的MVCC使用到的快照存储在Undo日志中，该日志通过回滚指针把一个数据行所有快照连接起来。

#### MVCC如何实现RR和RC

MVCC主要是通过版本链和ReadView来实现的
> 版本链：在InnoDB引擎表中，它的每一行记录中有两个必要的隐藏列：
> DATA\_TRX\_ID：表示插入或更新该行的最后一个事务的事务标识符
> DATA\_ROLL\_PTR：存储了一个指针，它指向这条记录的上一个版本的位置，通过它来获得上一个版本的记录信息。

> ReadView
> ReadView主要存放的是当前事务操作时，系统中任然活跃着的事务（事务开启后，没有提交或回滚的事务）

通过不同的ReadView的创建策略，实现不同的隔离级别：
1. 事务开启后，每一次读取都重新创建，实现RC
2. 事务开启后，第一次查询的时候创建，之后一直不变，直到事务结束，实现RR


### Mysql聚簇索引和非聚簇索引（二级索引）

![](https://img-blog.csdn.net/20161102111454921?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

#### 简单点说

聚簇索引： 将数据存储和索引放到了一块，找到索引就找到了数据
非聚簇索引：把数据存储和索引分开

**注意**： 
- innodb中，在聚簇索引上创建的索引是辅助索引，辅助索引访问数据总是要二次查找
- 非聚簇索引都是辅助索引，辅助索引叶子节点存储的不再是行的物理位置，而是主键值


#### 聚簇索引

准确的说，聚簇索引不算是索引，而是一种存储方式

**聚簇索引具有唯一性**：一个表仅有一个聚簇索引

innodb使用的就是聚簇索引，将主键组织到一棵B+树上，行数据就存储在叶子节点上，
- 如果我们用主键（id）去查找，就可以直接按B+树的检索算法找到叶子节点，进而获得行数据
- 如果我们不是用主键，而是用其它的，比如说Name，那么我们会在**辅助索引**B+树中先检索Name，到达叶子节点获得主键，然后像上一步一样从主键B+树中获得数据

#### 非聚簇索引

非聚簇索引的两棵B+树看上去没什么不同，节点的结构完全一致只是存储的内容不同而已，主键索引B+树的节点存储了主键，辅助键索引B+树存储了辅助键。

这两颗B+树的叶子节点都使用一个地址指向真正的表数据，对于表数据来说，这两个键没有任何差别。

由于**索引树是独立的，通过辅助键检索无需访问主键的索引树**。

### 聚簇索引的优势

看上去聚簇索引的效率明显要低于非聚簇索引，因为**每次使用辅助索引检索都要经过两次B+树查找**，这不是多此一举吗？聚簇索引的优势在哪？

1. 提高访问速度：由于**行数据和叶子节点存储在一起，同一页中会有多条行数据，访问同一数据页不同行记录时，已经把页加载到了Buffer中，再次访问的时候，会在内存中完成访问**，不必访问磁盘。
2. 方便维护：**辅助索引使用主键作为"指针"而不是使用地址值作为指针的好处**是，**减少了当出现行移动或者数据页分裂时辅助索引的维护工作**（使用主键值当作指针会让辅助索引占用更多的空间，换来的好处是InnoDB在移动行时无须更新辅助索引中的这个"指针"）
3. 聚簇索引适合用在排序的场合，非聚簇索引不适合
4. 取出一定范围数据的时候，使用用聚簇索引

### 聚簇索引的劣势：
1. **维护索引代价很大**，特别是**插入新行**或者**主键被更新导致分页**(page split)的时候
2. 如果主键比较大的话，那辅助索引将会变的更大，占用过多空间


### 2.为什么一般用自增列作为主键？

-   如果表使用自增主键，那么每次插入新的记录，记录就会顺序添加到当前索引节点的后续位置，当一页写满，就会自动开辟一个新的页。（**聚簇索引的数据的物理存放顺序与索引顺序是一致的**，即：**只要索引是相邻的，那么对应的数据一定也是相邻地存放在磁盘上的**。）


-   如果使用非自增主键（如果身份证号或学号等），由于每次插入主键的值近似于随机，因此每次新记录都要被插到现有索引页的中间某个位置，此时MySQL不得不为了将新记录插到合适位置而移动数据，这增加了很多开销，同时会增加大量的碎片。



#### Innodb中聚簇索引的建立过程

1. 有主键，就根据主键建立聚簇索引
2. 没有主键，就用一个唯一且不允许为空的索引列作为主键，建立聚簇索引
3. 以上都不满足，InnoDB会自己创建一个虚拟的字段作为主键（长整型，长度为六个字节），建立聚簇索引

